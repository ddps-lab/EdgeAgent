# MCP Git Server with mcp-proxy (stateless HTTP mode) + ToolTimer profiling
#
# Uses mcp-proxy to expose stdio-based MCP server over HTTP
# Patched with ToolTimer for timing measurements
#
# Usage:
#   docker build -f Dockerfile.git -t edgeagent-mcp-git .
#   docker run -p 8080:8080 -v /my/repo:/repo edgeagent-mcp-git

FROM python:3.11-slim

WORKDIR /app

# Install git and Node.js for mcp-proxy
RUN apt-get update && apt-get install -y git curl && \
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Install mcp-proxy (Node) and git server (Python)
RUN npm install -g mcp-proxy && \
    pip install --no-cache-dir mcp-server-git

# Copy patched files with ToolTimer
COPY servers/patches/python/timing.py /usr/local/lib/python3.11/site-packages/mcp_server_git/
COPY servers/patches/python/git_server_patched.py /usr/local/lib/python3.11/site-packages/mcp_server_git/server.py

# Environment variables
ENV MCP_PORT=8080

# Expose HTTP port
EXPOSE 8080

# Run mcp-proxy in stateless mode (with safe.directory for mounted repos)
CMD ["sh", "-c", "git config --global --add safe.directory '*' && mcp-proxy --port ${MCP_PORT} --stateless mcp-server-git"]
